<!DOCTYPE HTML>
<html>
<meta charset="utf-8">
<title>Data Lab Project</title>
<script src="https://d3js.org/d3.v4.min.js"> </script>
<head>
	<link rel="stylesheet" type="text/css" href="static/css/style.css">
</head>

<div id="tooltip" class="hidden">
	<p><strong>Path Information</strong></p>
	<p><span id="value">100</span>%</p>
</div>

<div class="dashboard">
	<div class="header">
		<p> Enter the values in the fields below!</p>
		<form>
			Start Hour = <input id="startHour" type="text" name="startHour" value=0>
			End Hour = <input id="endHour" type="text" name="endHour" value=23>
			Weekday is = <input id="Weekday" type="text" name="Weekday" value=0>
			Building is = <input id="Building" type="text" name="Building" value="Enter Building">
			<input name="update" type="Button" value="Update!" onclick="updateData()">
		</form>
	</div>
	<div class="body">
		<div class="sidebar">This is the sidebar</div>
		<div class="geoplot">
			<img src="static/images/campus_map3.png"/>
		</div>
		<div class="plots">
			<div id="plot1" class="plot1"></div>
			<div id = "plot2" class="plot2">
				<div id="tooltip" class="hidden">
					<p><strong>Path Information</strong></p>
					<p><span id="value">100</span>%</p>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">

	var building_table = d3.map();
	function lookupTable(data) {
		data.forEach(function(d){
			building_table = building_table.set(d.building_names, [d.longitude, d.latitude]);
		});
	}

	d3.json("/api/building_coords", lookupTable);

</script>

<script type="text/javascript">

	
	//Width and height
	var w = 600;
	var h = 250;
	var margin = { left: 30, top: 30, right: 30, bottom: 30 };
	var barPadding = .05;
	var yColumn = "count";
	var xColumn = "end";

	//Inner SVG dimensions
	var innerWidth  = w  - margin.left - margin.right;
	var innerHeight = h - margin.top  - margin.bottom;

	var initialized = 0;

	var xScale = d3.scaleBand()
					//.domain(d3.range(dataset.length))
					.range([0, innerWidth], barPadding)
					.padding(barPadding);

	var yScale = d3.scaleLinear()
					//.domain([0, d3.max(dataset)])
					.range([innerHeight, 0]);

	var cScale = d3.scaleLinear()
					.range([50, 250]);
	
	//Create SVG element
	var svg = d3.select("#plot2")
				.append("svg")
				.attr("width", w)
				.attr("height", h);

	//Appending group to svg
	var g = svg.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	//Adding x-axis to new group and translating axis
	var xAxisG = g.append("g")
	.attr("transform", "translate(0," + innerHeight + ")");

	//Adding y-axis to new group but setting no attributes
	var yAxisG = g.append("g");

	//x and y axis
	var xAxis = d3.axisBottom(xScale);
	var yAxis = d3.axisLeft(yScale);

	//Create bars
	function render(data){

		initialized = 1;

		yScale.domain([0, d3.max(data, function (d){ return d[yColumn]; })]);
		xScale.domain(data.map( function (d){ return d[xColumn]; }));
		cScale.domain([d3.min(data, function (d){ return d[yColumn]; }), d3.max(data, function (d){ return d[yColumn]; })]);

		xAxisG.call(xAxis);
		yAxisG.call(yAxis);

		var bars = g.selectAll("rect")
		   .data(data)
		   .enter()
		   .append("rect")
		   .attr("x", function(d) {
		   		return xScale(d[xColumn]);
		   })
		   .attr("y", function(d) {
		   		return yScale(d[yColumn]);
		   })
		   .attr("width", xScale.bandwidth())
		   .attr("height", function(d) {
		   		return innerHeight - yScale(d[yColumn]);
		   })
		   .attr("fill", function(d) {
		   		console.log(cScale(d[yColumn]));
				return "rgb(0, 0, " + (Math.round(cScale(d[yColumn]))) + ")";
		   })
		   .on("mouseover", function(d) {

				//Get this bar's x/y values, then augment for the tooltip
				var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.bandwidth() / 2;
				var yPosition = parseFloat(d3.select(this).attr("y")) / 2 + h / 2;

				//Update the tooltip position and value
				d3.select("#tooltip")
					.style("left", xPosition + "px")
					.style("top", yPosition + "px")						
					.select("#value")
					.text("There are "+d.count+" people going to "+d.end);
		   
				//Show the tooltip
				d3.select("#tooltip").classed("hidden", false);

		   })
		   .on("mouseout", function() {
		   
				//Hide the tooltip
				d3.select("#tooltip").classed("hidden", true);
				
		   });

		   //bars.exit().remove();
	}
	function type(data) {
		//console.log(data);
		data.forEach(function(d){
			d.count = +d.count;
		});
		render(data);
	}
	function update(data){
		console.log("UPDATING NOW!");
		data.forEach(function(d){
			d.count = +d.count;
		});

		yScale.domain([0, d3.max(data, function (d){ return d[yColumn]; })]);
		xScale.domain(data.map( function (d){ return d[xColumn]; }));
		cScale.domain([d3.min(data, function (d){ return d[yColumn]; }), d3.max(data, function (d){ return d[yColumn]; })]);

		xAxisG.call(xAxis);
		yAxisG.call(yAxis);

		g.selectAll("rect")
		   .data(data)
		   .transition()
		   .attr("x", function(d) {
		   		return xScale(d[xColumn]);
		   })
		   .attr("y", function(d) {
		   		return yScale(d[yColumn]);
		   })
		   .attr("width", xScale.bandwidth())
		   .attr("height", function(d) {
		   		return innerHeight - yScale(d[yColumn]);
		   })
		   .attr("fill", function(d) {
		   		console.log(cScale(d[yColumn]));
				return "rgb(0, 0, " + (Math.round(cScale(d[yColumn]))) + ")";
		   });

	}

	function printData(data){
		console.log("MADE IT HERE! "+ data);
		console.log("TIME: "+data[0]['Time']);
		data[0]['Time'].forEach(function(d){
			console.log(d['Hour'], d['Count']);
		});
	}

	function updateData(){

			var startHour = d3.select("#startHour").property("value");
			var endHour = 1 + parseInt(d3.select("#endHour").property("value"));
			console.log("startHour: " + startHour)
			console.log("endHour: " + endHour)
			console.log("newRange: " + d3.range(startHour, endHour))
			var Hour = d3.range(startHour, endHour)
			var Weekday = d3.select("#Weekday").property("value");
			var Building = d3.select("#Building").property("value");
			console.log("HOUR IS: "+Hour.toString()+" WEEKDAY IS: "+Weekday+" BUILDING IS: "+Building);

			d3.json("/api/all?Hour="+Hour.toString()+"&Weekday="+Weekday+"&Building="+Building, printData);


			if (initialized==0){
				d3.json("/api/wifi?Hour="+Hour.toString()+"&Weekday="+Weekday+"&Building="+Building, type);
				d3.json("/api/connections?Hour="+Hour.toString()+"&Weekday="+Weekday+"&Building="+Building, type2);
			}
			else{
				d3.json("/api/wifi?Hour="+Hour.toString()+"&Weekday="+Weekday+"&Building="+Building, update);
				d3.json("/api/connections?Hour="+Hour.toString()+"&Weekday="+Weekday+"&Building="+Building, update2);
			}
	}

</script>
<script>      

      //Width and height
      var w2 = 300;
      var h2 = 300;
      var circleRadius = 5;
      var margin2 = { left: 50, top: 30, right: 30, bottom: 30 };
      var xColumn2 = 'Hour';
      var yColumn2 = 'Count';

      //Inner SVG dimensions
      var innerWidth2  = w2 - margin2.left - margin2.right;
      var innerHeight2 = h2 - margin2.top  - margin2.bottom;

      var svg2 = d3.select("#plot1").append("svg")
        .attr("width", w2)
        .attr("height", h2);

      var xScale2 = d3.scaleBand().range([0, innerWidth2]);
      var yScale2 = d3.scaleLinear().range([innerHeight2, 0]);

      //Appending group to svg
      var g2 = svg2.append("g")
      .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

      //Adding x-axis to new group and translating axis
      var xAxisG2 = g2.append("g")
                    .attr("transform", "translate(0," + innerHeight2 + ")");

      //Adding y-axis to new group but setting no attributes
      var yAxisG2 = g2.append("g");

      //x and y axis
      var xAxis2 = d3.axisBottom(xScale2);
      var yAxis2 = d3.axisLeft(yScale2);

      // // text label for the y axis
      // g2.append("text")
      //       .attr("transform", "rotate(-90)")
      //       .attr("y", 0 - margin2.left)
      //       .attr("x",0 - (innerHeight2 / 2))
      //       .attr("dy", "1em")
      //       .style("text-anchor", "middle")
      //       .text("Count");

      // // text label for the x axis
      // svg2.append("text")             
      //     .attr("transform",
      //           "translate(" + (w2/2) + " ," + 
      //                          (innerHeight2 + margin2.top + 30) + ")")
      //     .style("text-anchor", "middle")
      //     .text("Hour");

      function render2(data){

      	// text label for the y axis
	    g2.append("text")
	            .attr("transform", "rotate(-90)")
	            .attr("y", 0 - margin2.left)
	            .attr("x",0 - (innerHeight2 / 2))
	            .attr("dy", "1em")
	            .style("text-anchor", "middle")
	            .text("Count");

	    // text label for the x axis
	    svg2.append("text")             
	          .attr("transform",
	                "translate(" + (w2/2) + " ," + 
	                               (innerHeight2 + margin2.top + 30) + ")")
	          .style("text-anchor", "middle")
	          .text("Hour");

        xScale2.domain(data.map( function (d){ return d[xColumn2]; }));
        yScale2.domain([0, d3.max(data, function (d){ return d[yColumn2]; })]);

        xAxisG2.call(xAxis2);
        yAxisG2.call(yAxis2);

        var circles = g2.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr("class", "circle")
          .attr("r", circleRadius);

        circles
          .attr("cx", function (d){ 
            console.log("d[xColumn]: " + d[xColumn2]);
            console.log("xScale(d[xColumn]): " + xScale2(d[xColumn2]));
            return xScale2(d[xColumn2]) + margin2.right - circleRadius; })
          .attr("cy", function (d){ return yScale2(d[yColumn2]); });
        
        circles.exit().remove();

      }

      // function type2(d){
      //   console.log("TYPE: " + d.Count);
      //   d.Count = +d.Count;
      //   //d.Hour = +d.Hour;
      //   return d;
      // }
      function type2(data) {
		//console.log(data);
		data.forEach(function(d){
			d.Count = +d.Count;
		});
		render2(data);
	}

      function update2(data){
		console.log("UPDATING CONNECTION TIME CHART NOW!");
		data.forEach(function(d){
			d.Count = +d.Count;
		});

		yScale2.domain([0, d3.max(data, function (d){ return d[yColumn2]; })]);
		xScale2.domain(data.map( function (d){ return d[xColumn2]; }));

		xAxisG2.call(xAxis2);
		yAxisG2.call(yAxis2);

		g2.selectAll("circle")
		   .data(data)
		   .transition()
		   .attr("cx", function (d){return xScale2(d[xColumn2]) + margin2.right - circleRadius; })
          .attr("cy", function (d){ return yScale2(d[yColumn2]); });

	}
      // var the_data = [{"Hour":0,"Count":3781},{"Hour":1,"Count":2949},{"Hour":2,"Count":2646},{"Hour":3,"Count":2055},{"Hour":4,"Count":909}];
      // console.log(the_data);
      // //data = type(data);
      // render(the_data);
   

    </script>

</body>

</html>